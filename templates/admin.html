<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Complaints</title>
    <link rel="stylesheet" href="/static/css/web.css" />
    <style>
      /* ===== v0.5.1 One-line Update Row on Desktop ===== */
      .updateControls {
        width: 100%;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap; /* mobile ยัง wrap ได้ */
      }

      .updateForm {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap; /* mobile ยัง wrap ได้ */
        flex: 1;
      }

      @media (min-width: 900px) {
        .updateControls {
          flex-wrap: nowrap;
        }
        .updateForm {
          flex-wrap: nowrap;
        }
        .proofUpload {
          min-width: 0;
        }
        .statusSelect {
          flex: 1;
          min-width: 260px;
        }
        #updateBtn {
          min-width: 160px;
        }
      }

      /* ===== Responsive Update Row ===== */
      @media (max-width: 599px) {
        .updateControls {
          flex-direction: column;
          align-items: stretch;
        }
        .updateForm {
          flex-direction: column;
          align-items: stretch;
        }
        .proofUpload,
        .statusSelect,
        #updateBtn {
          width: 100%;
        }
        form[data-delete="1"],
        form[data-delete="1"] .btn {
          width: 100%;
        }
      }

      @media (min-width: 600px) and (max-width: 899px) {
        .updateControls {
          flex-wrap: nowrap;
        }
        .updateForm {
          flex-wrap: nowrap;
        }
        .proofUpload {
          min-width: 180px;
          flex: 0 0 auto;
        }
        .statusSelect {
          min-width: 0;
          flex: 1 1 auto;
        }
        #updateBtn {
          flex: 0 0 auto;
          white-space: nowrap;
        }
        form[data-delete="1"] {
          flex: 0 0 auto;
          white-space: nowrap;
        }
      }

      /* ===== Complaint Detail Layout (Desktop 2 columns) ===== */

      .detailSplit {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 12px;
      }

      @media (min-width: 900px) {
        .detailSplit {
          grid-template-columns: 1fr 1fr;
          align-items: start;
        }
      }

      /* ===== Media Slider ===== */
      .mediaSlider {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
        overflow: hidden;
      }

      .mediaSliderTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
      }

      .mediaSliderCounter {
        font-weight: 900;
        color: var(--muted);
      }

      .mediaSlide {
        display: none;
        padding: 10px 12px 12px 12px;
        position: relative;
      }

      .mediaSlide.active {
        display: block;
      }

      .media {
        width: 100%;
        max-height: 360px;
        border-radius: 12px;
        border: 1px solid var(--border);
        object-fit: contain;
      }

      .sliderNavBtn {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: #fff;
        cursor: pointer;
        font-weight: 900;
      }

      .mediaDeleteBtn {
        position: absolute;
        top: 16px;
        right: 16px;
        border: 1px solid rgba(239, 68, 68, 0.45);
        background: rgba(255, 255, 255, 0.92);
        color: #b91c1c;
        border-radius: 12px;
        padding: 8px 10px;
        font-weight: 900;
        cursor: pointer;
        backdrop-filter: blur(6px);
      }
      .mediaDeleteBtn:hover {
        background: rgba(239, 68, 68, 0.12);
      }

      /* ===== Proof Upload (brown box) ===== */
      .proofUpload {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px dashed rgba(30, 115, 216, 0.45);
        background: rgba(30, 115, 216, 0.04);
        cursor: pointer;
        font-weight: 900;
        min-width: 220px;
      }
      .proofUpload input[type="file"] {
        display: none;
      }
      .proofHint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }

      .btn.danger {
        background: rgba(239, 68, 68, 0.12);
        color: #b91c1c;
        border: 1px solid rgba(239, 68, 68, 0.35);
      }

      .tabs {
        padding: 10px 10px 0 10px;
        display: flex;
        gap: 10px;
      }

      .tab {
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 14px;
        padding: 10px 14px;
        font-weight: 900;
        cursor: pointer;
      }

      .tab.active {
        background: rgba(30, 115, 216, 0.1);
        border-color: rgba(30, 115, 216, 0.35);
        color: var(--primary);
      }

      .listItem.clickable {
        cursor: pointer;
      }

      .listItem.clickable:hover {
        border-color: rgba(30, 115, 216, 0.35);
        background: rgba(30, 115, 216, 0.04);
      }

      .listItem.selected {
        border-color: rgba(30, 115, 216, 0.45);
        background: rgba(30, 115, 216, 0.06);
      }

      .inlineDetail {
        margin-top: 10px;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: #fff;
      }

      .inlineDetailHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .smallBtn {
        padding: 9px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        cursor: pointer;
        font-weight: 800;
      }

      .adminUpdateRow {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      /* ===== Status Colors ===== */
      .badge.status-wait {
        border-color: rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.1);
        color: #b91c1c;
      }

      .badge.status-progress {
        border-color: rgba(234, 179, 8, 0.45);
        background: rgba(234, 179, 8, 0.18);
        color: #854d0e;
      }

      .badge.status-done {
        border-color: rgba(34, 197, 94, 0.35);
        background: rgba(34, 197, 94, 0.12);
        color: #166534;
      }

      .statusSelect {
        min-width: 0;
        flex: 1 1 auto;
        font-weight: 900;
      }

      .statusSelect.status-wait {
        border-color: rgba(239, 68, 68, 0.45);
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        color: #b91c1c;
      }

      .statusSelect.status-progress {
        border-color: rgba(234, 179, 8, 0.55);
        box-shadow: 0 0 0 4px rgba(234, 179, 8, 0.12);
        color: #854d0e;
      }

      .statusSelect.status-done {
        border-color: rgba(34, 197, 94, 0.45);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        color: #166534;
      }

      /* ===== Filter UI (Responsive + Scroll) ===== */
      .headerRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      .searchRow {
        margin: 10px 0 14px 0;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .searchInput {
        flex: 1 1 260px;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px 12px;
        font-weight: 900;
        outline: none;
        background: #fff;
      }
      .searchInput:focus {
        border-color: rgba(30, 115, 216, 0.35);
      }

      .filterBtn {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex: 0 0 auto;
      }

      .filterBtn:hover {
        border-color: rgba(30, 115, 216, 0.35);
        background: rgba(30, 115, 216, 0.05);
      }

      .filterOverlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.38);
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding: 16px 12px;
        z-index: 9999;
        overflow: auto;
        /* overlay scroll ได้ */
      }

      .filterPanel {
        width: 560px;
        max-width: 94vw;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: none;

        padding: 14px;

        /* เปลี่ยนให้เป็น layout แบบ column แล้วให้ body เป็นตัว scroll */
        display: flex;
        flex-direction: column;

        max-height: calc(100vh - 32px);
        overflow: hidden;
        /* ห้าม panel scroll โดยตรง */
      }

      @media (max-width: 480px) {
        .filterPanel {
          width: 100%;
          max-width: 100%;
          border-radius: 16px;
        }
      }

      .filterPanel h3 {
        margin: 0;
        font-size: 18px;
      }

      .filterTop {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;

        /* ไม่ใช้ sticky แล้ว เพื่อกันทะลุ header */
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
        background: #fff;
      }

      .chipRow {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .checkGrid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }

      @media (max-width: 480px) {
        .checkGrid {
          grid-template-columns: 1fr;
        }
      }

      .checkItem {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .filterBody {
        /* ส่วนนี้เท่านั้นที่ scroll */
        overflow: auto;
        padding-right: 4px;
        /* กัน scrollbar ทับ */
        flex: 1 1 auto;
      }

      .filterActions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 12px;
        flex-wrap: wrap;

        /* ไม่ใช้ sticky แล้ว */
        padding-top: 10px;
        border-top: 1px solid var(--border);
        background: #fff;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <div class="app">
      <div class="card">
        <div class="topbar">
          <div class="brand">Admin Dashboard</div>
          <a class="link" href="/logout">ออกจากระบบ</a>
        </div>

        <div class="tabs">
          <button class="tab" type="button" id="tabDash">Dash board</button>
          <button class="tab active" type="button" id="tabList">
            รายการเรื่องร้องเรียน
          </button>
          {% if role == "root" %}
          <button class="tab" type="button" id="tabUsers">จัดการผู้ใช้</button>
          {% endif %}
        </div>

        <div class="content">
          <div class="headerRow">
            <h2 class="title" style="margin: 0">รายการเรื่องร้องเรียน</h2>

            <button
              class="filterBtn"
              type="button"
              id="openFilter"
              aria-label="filter"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M3 5h18l-7 8v5l-4 2v-7L3 5z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>

          <!-- Search (v1.3.1) -->
          <div class="searchRow">
            <input
              class="searchInput"
              id="complaintSearch"
              type="text"
              placeholder="ค้นหาในรายการร้องเรียน..."
              autocomplete="off"
            />
            <button class="smallBtn" type="button" id="clearComplaintSearch">
              ล้าง
            </button>
          </div>

          {% if complaints|length == 0 %}

          <div class="empty">ยังไม่มีรายการร้องเรียน</div>
          {% else %}
          <div id="list" class="list">
            {% for c in complaints %}
            <div
              class="listItem clickable"
              data-id="{{ c.id }}"
              data-status="{{ c.status or '' }}"
              data-building="{{ c.building or '' }}"
              data-itemtype="{{ c.item_type or '' }}"
              data-location="{{ c.location or '' }}"
            >
              <div class="row">
                <div class="col">
                  <div class="label">วันที่แจ้ง</div>
                  <div class="value">{{ c.created_at_fmt }}</div>
                </div>
                <div class="col">
                  <div class="label">ผู้ร้องเรียน</div>
                  <div class="value">{{ c.username }}</div>
                </div>
                <div class="col">
                  <div class="label">สถานที่</div>
                  <div class="value">{{ c.location or "-" }}</div>
                </div>
                <div class="col">
                  <div class="label">สถานะ</div>
                  <div class="badge jsStatusBadge">{{ c.status or "-" }}</div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <div class="footer">
            © 2025 PCCM Service. This system is developed for educational
            purposes.
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Overlay -->
    <div class="filterOverlay" id="filterOverlay">
      <div class="filterPanel">
        <div class="filterTop">
          <h3>ตัวกรองรายการ</h3>
          <button class="smallBtn" type="button" id="closeFilter">ปิด</button>
        </div>

        <div class="filterBody">
          <!-- STATUS -->
          <div class="detailBox" style="margin-top: 0">
            <div class="label">สถานะ</div>
            <div class="chipRow">
              <button class="smallBtn" type="button" id="pickDone">
                เลือก: เสร็จแล้ว
              </button>
              <button class="smallBtn" type="button" id="pickNotDone">
                เลือก: ยังไม่เสร็จ
              </button>
              <button class="smallBtn" type="button" id="clearStatus">
                ล้างสถานะ
              </button>
            </div>

            <div class="checkGrid">
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="statusCheck"
                  value="รอดำเนินการ"
                />
                รอดำเนินการ</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="statusCheck"
                  value="กำลังดำเนินการ"
                />
                กำลังดำเนินการ</label
              >
              <label class="checkItem"
                ><input type="checkbox" class="statusCheck" value="เสร็จสิ้น" />
                เสร็จสิ้น</label
              >
              <label class="checkItem"
                ><input type="checkbox" class="statusCheck" value="ยกเลิก" />
                ยกเลิก</label
              >
            </div>
          </div>

          <!-- BUILDING -->
          <div class="detailBox" style="margin-top: 12px">
            <div class="label">อาคาร</div>
            <div class="chipRow">
              <button class="smallBtn" type="button" id="clearBuilding">
                ล้างอาคาร
              </button>
            </div>

            <div class="checkGrid">
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="buildingCheck"
                  value="อาคารปฏิบัติการวิศวกรรม"
                />
                อาคารปฏิบัติการวิศวกรรม</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="buildingCheck"
                  value="อาคารเรียนราชวิทย์"
                />
                อาคารเรียนราชวิทย์</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="buildingCheck"
                  value="อาคารอำนวยการ"
                />
                อาคารอำนวยการ</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="buildingCheck"
                  value="อาคารปฏิบัติการทางวิทยาศาสตร์"
                />
                อาคารปฏิบัติการทางวิทยาศาสตร์</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="buildingCheck"
                  value="โรงอาหาร"
                />
                โรงอาหาร</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="buildingCheck"
                  value="อาคารศูนย์กีฬา"
                />
                อาคารศูนย์กีฬา</label
              >
            </div>
          </div>

          <!-- ITEM TYPE -->
          <div class="detailBox" style="margin-top: 12px">
            <div class="label">ประเภทสิ่งของ</div>
            <div class="chipRow">
              <button class="smallBtn" type="button" id="clearItemType">
                ล้างประเภทสิ่งของ
              </button>
            </div>

            <div class="checkGrid">
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="itemTypeCheck"
                  value="ไฟฟ้า/ไฟสว่าง"
                />
                ไฟฟ้า/ไฟสว่าง</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="itemTypeCheck"
                  value="น้ำ/ห้องน้ำ"
                />
                น้ำ/ห้องน้ำ</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="itemTypeCheck"
                  value="ห้องเรียน/อาคาร"
                />
                ห้องเรียน/อาคาร</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="itemTypeCheck"
                  value="ประตู/หน้าต่าง"
                />
                ประตู/หน้าต่าง</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="itemTypeCheck"
                  value="โต๊ะ/เก้าอี้/เฟอร์นิเจอร์"
                />
                โต๊ะ/เก้าอี้/เฟอร์นิเจอร์</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="itemTypeCheck"
                  value="คอมพิวเตอร์/โปรเจคเตอร์/อินเทอร์เน็ต"
                />
                คอมพิวเตอร์/โปรเจคเตอร์/อินเทอร์เน็ต</label
              >
              <label class="checkItem"
                ><input
                  type="checkbox"
                  class="itemTypeCheck"
                  value="อุปกรณ์กีฬา/เครื่องออกกำลังกาย"
                />
                อุปกรณ์กีฬา/เครื่องออกกำลังกาย</label
              >
            </div>
          </div>
        </div>

        <div class="filterActions">
          <button class="btn outline" type="button" id="resetAll">
            รีเซ็ตทั้งหมด
          </button>
          <button class="btn primary" type="button" id="applyFilter">
            ใช้ตัวกรอง
          </button>
        </div>
      </div>
    </div>

    <script>
      // tabs
      // tabs
      document
        .getElementById("tabDash")
        .addEventListener("click", () =>
          window.location.replace("/admin/dashboard"),
        );
      document
        .getElementById("tabList")
        .addEventListener("click", () =>
          window.location.replace("/admin/complaints"),
        );
      document
        .getElementById("tabUsers")
        ?.addEventListener("click", () =>
          window.location.replace("/admin/users"),
        );

      const CURRENT_ROLE = "{{ role }}";

      // ===== Helpers =====
      function escapeHtml(s) {
        return (s ?? "")
          .toString()
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function statusClass(status) {
        if (status === "รอดำเนินการ") return "status-wait";
        if (status === "กำลังดำเนินการ") return "status-progress";
        if (status === "เสร็จสิ้น") return "status-done";
        return ""; // ยกเลิก = เดิม
      }

      function normalizeBuilding(itemEl) {
        const b = (itemEl.getAttribute("data-building") || "").trim();
        if (b) return b;
        const loc = (itemEl.getAttribute("data-location") || "").trim();
        if (loc.includes(" - ")) return loc.split(" - ")[0].trim();
        return loc || "-";
      }

      // apply badge colors
      document.querySelectorAll(".listItem[data-id]").forEach((item) => {
        const st = item.getAttribute("data-status") || "";
        const badge = item.querySelector(".jsStatusBadge");
        if (badge) {
          const cls = statusClass(st);
          if (cls) badge.classList.add(cls);
        }
      });

      // ===== Inline Detail (เหมือน v0.3.7) =====
      const list = document.getElementById("list");

      // ===== Search (v1.3.1) =====
      const complaintSearch = document.getElementById("complaintSearch");
      const clearComplaintSearch = document.getElementById(
        "clearComplaintSearch",
      );
      let searchTerm = "";

      complaintSearch?.addEventListener("input", () => {
        searchTerm = (complaintSearch.value || "").trim().toLowerCase();
        applyFiltersToList();
      });

      clearComplaintSearch?.addEventListener("click", () => {
        if (complaintSearch) complaintSearch.value = "";
        searchTerm = "";
        applyFiltersToList();
      });

      let activeId = null;
      let detailEl = null;

      function clearSelection() {
        document
          .querySelectorAll(".listItem.selected")
          .forEach((el) => el.classList.remove("selected"));
      }
      function closeDetail() {
        activeId = null;
        clearSelection();
        if (detailEl) {
          detailEl.remove();
          detailEl = null;
        }
        if (list) list.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function renderMediaSlider(
        paths,
        sliderKey,
        title = "ไฟล์แนบ",
        emptyText = "ไม่มีไฟล์แนบ",
        deletable = false,
        complaintId = null,
      ) {
        if (!paths || paths.length === 0) {
          return `<div class="value">${escapeHtml(emptyText)}</div>`;
        }

        const sid = `s_${sliderKey}_${Math.random().toString(16).slice(2)}`;

        let slides = "";
        for (let i = 0; i < paths.length; i++) {
          const p = paths[i];
          const lower = (p || "").toLowerCase();
          if (lower.endsWith(".mp4")) {
            slides += `
<div class="mediaSlide" data-idx="${i}">
  ${
    deletable
      ? `<button type="button" class="mediaDeleteBtn" data-complaint-id="${escapeHtml(
          complaintId,
        )}" data-file-path="${escapeHtml(p)}">ลบไฟล์</button>`
      : ``
  }
  <video class="media" controls src="${escapeHtml(p)}"></video>
</div>`;
          } else {
            slides += `
<div class="mediaSlide" data-idx="${i}">
  ${
    deletable
      ? `<button type="button" class="mediaDeleteBtn" data-complaint-id="${escapeHtml(
          complaintId,
        )}" data-file-path="${escapeHtml(p)}">ลบไฟล์</button>`
      : ``
  }
  <img class="media" src="${escapeHtml(p)}" alt="attachment"/>
</div>`;
          }
        }

        const showNav = paths.length > 1;

        return `
<div class="mediaSlider" data-slider="${sid}">
  <div class="mediaSliderTop">
    <div style="font-weight:900;">${escapeHtml(title)}</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div class="mediaSliderCounter"><span class="jsCur">1</span>/<span class="jsTot">${paths.length}</span></div>
      ${
        showNav
          ? `
        <button class="sliderNavBtn" type="button" data-dir="-1">‹</button>
        <button class="sliderNavBtn" type="button" data-dir="1">›</button>
      `
          : ``
      }
    </div>
  </div>
  <div class="mediaSliderViewport">
    ${slides}
  </div>
</div>`;
      }

      function initSliders(scopeEl) {
        (scopeEl || document)
          .querySelectorAll(".mediaSlider[data-slider]")
          .forEach((sl) => {
            const slides = Array.from(sl.querySelectorAll(".mediaSlide"));
            if (!slides.length) return;

            let idx = 0;
            const curEl = sl.querySelector(".jsCur");
            const totEl = sl.querySelector(".jsTot");

            function show(i) {
              idx = (i + slides.length) % slides.length;
              slides.forEach((s) => s.classList.remove("active"));
              slides[idx].classList.add("active");
              if (curEl) curEl.textContent = String(idx + 1);
              if (totEl) totEl.textContent = String(slides.length);
            }

            sl.querySelectorAll(".sliderNavBtn").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const dir = parseInt(btn.getAttribute("data-dir") || "0", 10);
                show(idx + dir);
              });
            });

            show(0);
          });
      }

      function statusOptions(current) {
        const opts = ["รอดำเนินการ", "กำลังดำเนินการ", "เสร็จสิ้น", "ยกเลิก"];
        const placeholder = `<option value="" ${!current ? "selected" : ""} disabled>เลือกสถานะ</option>`;
        const items = opts
          .map(
            (s) =>
              `<option value="${s}" ${current === s ? "selected" : ""}>${s}</option>`,
          )
          .join("");
        return placeholder + items;
      }

      function applySelectColor(selectEl) {
        selectEl.classList.remove(
          "status-wait",
          "status-progress",
          "status-done",
        );
        const cls = statusClass(selectEl.value);
        if (cls) selectEl.classList.add(cls);
      }

      async function openDetailUnder(itemEl, id) {
        clearSelection();
        itemEl.classList.add("selected");

        if (detailEl) {
          detailEl.remove();
          detailEl = null;
        }

        detailEl = document.createElement("div");
        detailEl.className = "inlineDetail";
        detailEl.innerHTML = `
        <div class="inlineDetailHeader">
          <div style="font-weight:900;">รายละเอียดเรื่องร้องเรียน</div>
          <button class="smallBtn" type="button" id="inlineCloseBtn">ปิด</button>
        </div>
        <div class="empty">กำลังโหลดรายละเอียด...</div>
      `;
        itemEl.insertAdjacentElement("afterend", detailEl);
        detailEl.scrollIntoView({ behavior: "smooth", block: "start" });

        detailEl
          .querySelector("#inlineCloseBtn")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            closeDetail();
          });

        const res = await fetch(`/admin/complaint/${id}/detail`, {
          method: "GET",
        });
        if (!res.ok) {
          detailEl.querySelector(".empty").textContent = "ไม่พบรายละเอียด";
          return;
        }
        const d = await res.json();

        const attHtml = renderMediaSlider(
          d.attachments || [],
          `att_${d.id}`,
          "ไฟล์แนบ",
          "ไม่มีไฟล์แนบ",
        );
        const canDeleteWork =
          CURRENT_ROLE === "admin" || CURRENT_ROLE === "root";
        const workHtml = renderMediaSlider(
          d.work_attachments || [],
          `work_${d.id}`,
          "ไฟล์หน้างาน (หลักฐานการดำเนินงาน)",
          "ยังไม่มีไฟล์หน้างาน",
          canDeleteWork,
          d.id,
        );

        const showDelete = CURRENT_ROLE === "root";
        const deleteHtml = showDelete
          ? `
<form method="post" action="/admin/delete-complaint" style="display:inline-flex;" data-delete="1">
  <input type="hidden" name="complaint_id" value="${escapeHtml(d.id)}">
  <button class="btn danger jsDeleteComplaint" type="submit">ลบคำร้อง</button>
</form>

`
          : ``;

        detailEl.innerHTML = `
<div class="inlineDetailHeader">
  <div style="font-weight:900;">รายละเอียดเรื่องร้องเรียน</div>
  <button class="smallBtn" type="button" id="inlineCloseBtn">ปิด</button>
</div>

<div class="detailSplit">
  <div>
    <div class="detailBox" style="margin-top:0;">
      <div class="label">ประเภทสิ่งของ</div>
      <div class="value">${escapeHtml(d.item_type || "-")}</div>
    </div>

    <div class="detailBox" style="margin-top:12px;">
      <div class="label">รายละเอียด</div>
      <div class="value" style="white-space:pre-wrap;">${escapeHtml(d.description || "-")}</div>
    </div>
  </div>

  <div>
    ${attHtml}
  </div>
</div>

<div class="detailBox" style="margin-top:12px;">
  ${workHtml}
  <div class="proofHint">* ไฟล์หน้างานจะแสดงให้ผู้ร้องเรียน (Student) เห็นด้วย</div>
</div>

<div class="adminUpdateRow">
  <div class="updateControls">
    <form method="post" action="/admin/update-status" id="statusForm" class="updateForm" enctype="multipart/form-data" novalidate>

      <input type="hidden" name="complaint_id" value="${escapeHtml(d.id)}">

      <label class="proofUpload" id="proofUploadBtn">
       <input type="file" name="work_files" id="workFiles" accept=".jpg,.jpeg,.png,.mp4" multiple>

        อัปโหลดหน้างาน
      </label>

     <select name="status" id="statusSelect" class="statusSelect">

        ${statusOptions(d.status)}
      </select>

      <button class="btn primary" id="updateBtn" type="submit">อัปเดตสถานะ</button>

    </form>

    ${deleteHtml}
  </div>
</div>

`;

        detailEl
          .querySelector("#inlineCloseBtn")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            closeDetail();
          });

        detailEl
          .querySelector("#statusForm")
          .addEventListener("click", (e) => e.stopPropagation());

        const sel = detailEl.querySelector("#statusSelect");
        if (sel) {
          applySelectColor(sel);
          sel.addEventListener("change", () => applySelectColor(sel));
          // init sliders
          initSliders(detailEl);

          // Admin/Root: delete work attachment
          detailEl.querySelectorAll(".mediaDeleteBtn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const cid = btn.getAttribute("data-complaint-id");
              const fp = btn.getAttribute("data-file-path");

              const r = await Swal.fire({
                icon: "warning",
                title: "ลบไฟล์หน้างาน?",
                text: "ไฟล์จะถูกลบออกจากระบบทันที",
                showCancelButton: true,
                confirmButtonText: "ยืนยันลบ",
                cancelButtonText: "ยกเลิก",
                confirmButtonColor: "#ef4444",
              });
              if (!r.isConfirmed) return;

              const f = document.createElement("form");
              f.method = "post";
              f.action = "/admin/delete-work-file";
              f.innerHTML = `
      <input type="hidden" name="complaint_id" value="${cid}">
      <input type="hidden" name="file_path" value="${fp}">
    `;
              document.body.appendChild(f);
              f.submit();
            });
          });

          // Require proof upload before update
          // Proof upload required ONLY when status is "เสร็จสิ้น"
          const workFilesInput = detailEl.querySelector("#workFiles");
          const updateBtn = detailEl.querySelector("#updateBtn");
          const proofBtn = detailEl.querySelector("#proofUploadBtn");
          const statusForm = detailEl.querySelector("#statusForm");

          // ✅ มีไฟล์หน้างานเดิมในระบบแล้วไหม (file input จะไม่โชว์ไฟล์เดิม)
          const hasExistingWork =
            Array.isArray(d.work_attachments) && d.work_attachments.length > 0;

          function isDoneStatus(v) {
            return (v || "").trim() === "เสร็จสิ้น";
          }

          function refreshUpdateEnable() {
            const statusVal = (sel?.value || "").trim();
            const statusChosen = statusVal.length > 0;

            const hasFiles =
              workFilesInput &&
              workFilesInput.files &&
              workFilesInput.files.length > 0;

            const needProof = isDoneStatus(statusVal);

            // ห้ามใช้ required กับ input file ที่ซ่อนไว้ (browser จะบล็อก submit)
            // ใช้ Popup บังคับแทน
            if (workFilesInput) workFilesInput.required = false;

            if (updateBtn) {
              // ต้องกดได้เสมอ เพื่อให้ Popup ทำงาน
              updateBtn.disabled = false;
            }

            if (proofBtn) {
              const hasProof = hasFiles || hasExistingWork;
              proofBtn.style.borderStyle = hasProof ? "solid" : "dashed";

              // ไม่แสดงวงเล็บ/คำอธิบายข้างปุ่ม (ตามที่ต้องการ)
              const label = hasFiles
                ? `อัปโหลดหน้างาน (${workFilesInput.files.length} ไฟล์)`
                : `อัปโหลดหน้างาน`;

              proofBtn.childNodes[proofBtn.childNodes.length - 1].textContent =
                label;
            }
          }

          workFilesInput?.addEventListener("change", refreshUpdateEnable);
          sel?.addEventListener("change", refreshUpdateEnable);
          refreshUpdateEnable();

          // Sweet popup validation before submit
          statusForm?.addEventListener("submit", (e) => {
            const statusVal = (sel?.value || "").trim();
            const statusChosen = statusVal.length > 0;
            const hasFiles =
              workFilesInput &&
              workFilesInput.files &&
              workFilesInput.files.length > 0;

            if (!statusChosen) {
              e.preventDefault();
              if (window.Swal) {
                Swal.fire({
                  icon: "warning",
                  title: "กรุณาเลือกสถานะ",
                  text: "โปรดเลือกสถานะก่อนทำการอัปเดต",
                  confirmButtonText: "ตกลง",
                });
              } else {
                alert("กรุณาเลือกสถานะก่อนทำการอัปเดต");
              }
              return;
            }
            if (isDoneStatus(statusVal) && !hasFiles && !hasExistingWork) {
              e.preventDefault();
              if (window.Swal) {
                Swal.fire({
                  icon: "warning",
                  title: "กรุณาอัปโหลดรูป/วิดีโอหน้างาน",
                  text: "ก่อนอัปเดตเป็นสถานะเสร็จสิ้น ต้องแนบไฟล์หน้างาน",
                  confirmButtonText: "ตกลง",
                });
              } else {
                alert("ก่อนอัปเดตเป็นสถานะเสร็จสิ้น ต้องแนบไฟล์หน้างาน");
              }
              return;
            }
          });

          // Root: confirm delete complaint
          const delForm = detailEl.querySelector('form[data-delete="1"]');
          delForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const r = await Swal.fire({
              icon: "warning",
              title: "ยืนยันการลบคำร้อง?",
              text: "เมื่อลบแล้วจะไม่สามารถกู้คืนได้",
              showCancelButton: true,
              confirmButtonText: "ยืนยันลบ",
              cancelButtonText: "ยกเลิก",
              confirmButtonColor: "#ef4444",
            });
            if (r.isConfirmed) delForm.submit();
          });
        }
      }

      if (list) {
        list.addEventListener("click", (e) => {
          const item = e.target.closest(".listItem[data-id]");
          if (!item) return;

          const id = item.getAttribute("data-id");
          if (activeId === id) {
            closeDetail();
            return;
          }
          activeId = id;
          openDetailUnder(item, id);
        });
      }

      // ===== Filter UI =====
      const overlay = document.getElementById("filterOverlay");
      document
        .getElementById("openFilter")
        ?.addEventListener("click", () => (overlay.style.display = "flex"));
      document
        .getElementById("closeFilter")
        ?.addEventListener("click", () => (overlay.style.display = "none"));
      overlay?.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.style.display = "none";
      });

      const statusChecks = () =>
        Array.from(document.querySelectorAll(".statusCheck"));
      const buildingChecks = () =>
        Array.from(document.querySelectorAll(".buildingCheck"));
      const itemTypeChecks = () =>
        Array.from(document.querySelectorAll(".itemTypeCheck"));

      function setStatusChecked(values) {
        const set = new Set(values);
        statusChecks().forEach((ch) => (ch.checked = set.has(ch.value)));
      }
      function clearChecks(getter) {
        getter().forEach((ch) => (ch.checked = false));
      }

      document
        .getElementById("pickDone")
        ?.addEventListener("click", () => setStatusChecked(["เสร็จสิ้น"]));
      document
        .getElementById("pickNotDone")
        ?.addEventListener("click", () =>
          setStatusChecked(["รอดำเนินการ", "กำลังดำเนินการ"]),
        );
      document
        .getElementById("clearStatus")
        ?.addEventListener("click", () => clearChecks(statusChecks));
      document
        .getElementById("clearBuilding")
        ?.addEventListener("click", () => clearChecks(buildingChecks));
      document
        .getElementById("clearItemType")
        ?.addEventListener("click", () => clearChecks(itemTypeChecks));

      function getSelectedValues(getter) {
        return getter()
          .filter((ch) => ch.checked)
          .map((ch) => ch.value);
      }

      function applyFiltersToList() {
        const selectedStatuses = new Set(getSelectedValues(statusChecks));
        const selectedBuildings = new Set(getSelectedValues(buildingChecks));
        const selectedItemTypes = new Set(getSelectedValues(itemTypeChecks));

        const items = document.querySelectorAll(".listItem[data-id]");
        let anyShown = false;

        items.forEach((item) => {
          const st = (item.getAttribute("data-status") || "").trim();
          const b = normalizeBuilding(item);
          const it = (item.getAttribute("data-itemtype") || "").trim();

          const okStatus =
            selectedStatuses.size === 0 || selectedStatuses.has(st);
          const okBuilding =
            selectedBuildings.size === 0 || selectedBuildings.has(b);
          const okItem =
            selectedItemTypes.size === 0 || selectedItemTypes.has(it);

          // Search จากข้อความในการ์ดทั้งหมด (ชัวร์สุด ไม่พึ่ง data-* เพิ่ม)
          const text = (item.textContent || "").toLowerCase();
          const okSearch = !searchTerm || text.includes(searchTerm);

          const show = okStatus && okBuilding && okItem && okSearch;
          item.style.display = show ? "" : "none";
          if (show) anyShown = true;
        });

        if (activeId) {
          const activeItem = document.querySelector(
            `.listItem[data-id="${activeId}"]`,
          );
          if (!activeItem || activeItem.style.display === "none") {
            closeDetail();
          }
        }

        if (!anyShown && list) {
          if (!document.getElementById("filterEmpty")) {
            const div = document.createElement("div");
            div.id = "filterEmpty";
            div.className = "empty";
            div.textContent = "ไม่พบรายการตามเงื่อนไข";
            list.insertAdjacentElement("beforebegin", div);
          }
        } else {
          document.getElementById("filterEmpty")?.remove();
        }
      }

      document.getElementById("applyFilter")?.addEventListener("click", () => {
        applyFiltersToList();
        overlay.style.display = "none";
      });

      document.getElementById("resetAll")?.addEventListener("click", () => {
        clearChecks(statusChecks);
        clearChecks(buildingChecks);
        clearChecks(itemTypeChecks);
        applyFiltersToList();
        overlay.style.display = "none";
      });
    </script>
  </body>
</html>
